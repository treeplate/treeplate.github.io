<!DOCTYPE html>
<html>
<head>
  <style>
    .bluebox{border: 10px ridge #0000ff;color:#ffff00;font-family: monospace;}
    .black{color: black;}
    span{color: red;}
  </style>
</head>
<body>
  <p class="hide bluebox black">
  Login page<br>
  Username:<input type="text" class="hide" title="username" id="username"><br>
  Password:<input type="password" class="hide" title="password" id="password">
  <button class="hide" onclick="login(true)">Submit</button>
  </p>
  <div class="show bluebox black" hidden>
<h1 id = "welcome"></h1>
    <button onclick="findUsers()">Refresh users</button>
    <h2>Users:</h2>
    <p id = "users"></p>
    <div id = "messages"></div>
    <p><input type="text" id="message"><button onclick="sendMessage()">Send</button>
<button onclick="logout()">Log out</button>
    
  </div>
  <script>
    var webSocket = new WebSocket("ws://treeplate.damowmow.com:8001");
    webSocket.onopen = function(){
      if(username !== null && password !== null){
        login(false);
      }
    }
    webSocket.onmessage = function(e){
      if(e.data.startsWith("request:")){
        var names = e.data.substring(8).split(",");
        for(var a = 0;a<names.length;a++){
          if(names[a].startsWith("webpage:")){
             names[a] = names[a].substring(8);
          }
        }
        var users = names.join(",");
        document.getElementById("users").innerHTML = users;
      }
      if(e.data.startsWith("message:")){
        var para = document.createElement("p");
        var name = e.data.substring(8)
        if(name.startsWith("webpage:"){
           name = e.data.substring(16)
        }
        var node = document.createTextNode(name);
        para.appendChild(node);
        var element = document.getElementById("messages");
        element.appendChild(para);
      }
    };
    webSocket.onerror = function(e){
      console.log(e);
    }
    webSocket.onclose = function(e){
      console.log(e);
    }
    var findUsers = function(){
      webSocket.send("request");
    };
    var sendMessage = function(){
      webSocket.send(document.getElementById("message").value);
    };
    var username = localStorage.getItem("username");
    var password = localStorage.getItem("password");
    var logout = function(){
      var x = document.getElementsByClassName("show");
      var i;
      for (i = 0; i < x.length; i++) {
        x[i].hidden = true;
      }
      var x = document.getElementsByClassName("hide");
      var i;
      for (i = 0; i < x.length; i++) {
        x[i].hidden = false;
      }
    };
    
    var login = function(resetLogin){
      if(resetLogin){
        username = document.getElementById("username").value;
        localStorage.setItem("username", username);
        password = document.getElementById("password").value;
        localStorage.setItem("password", password);
      }
      webSocket.send("user webpage:" + username);
      document.getElementById("welcome").innerHTML = "Hi "+username+" password "+password+"!";
      var x = document.getElementsByClassName("hide");
      var i;
      for (i = 0; i < x.length; i++) {
        x[i].hidden = true;
      }
      var x = document.getElementsByClassName("show");
      var i;
      for (i = 0; i < x.length; i++) {
        x[i].hidden = false;
      }
      
    };
    
    
  </script>
</body>
</html>
